import"./modulepreload-polyfill-B5Qt9EMX.js";import"./translations-l0sNRNKZ.js";import{_ as B,s as w,h as I}from"./modals-D-Pj_INv.js";import{u as E}from"./bimcoin-DS6TUAdR.js";import"https://cdn.jsdelivr.net/npm/ethers@6.10.0/+esm";const T="0x03c89df2366f99C8e4E4C9010143d54064c0E893",F=[{anonymous:!1,inputs:[{indexed:!1,internalType:"string",name:"hash",type:"string"},{indexed:!1,internalType:"string",name:"filename",type:"string"},{indexed:!1,internalType:"string",name:"version",type:"string"},{indexed:!1,internalType:"string",name:"description",type:"string"},{indexed:!1,internalType:"string",name:"datetime",type:"string"},{indexed:!0,internalType:"address",name:"author",type:"address"}],name:"ModelRegistered",type:"event"}];let L=[];document.addEventListener("DOMContentLoaded",async()=>{E();const n=document.getElementById("contractAddr");n&&(n.textContent=T);const d=document.getElementById("connect");d&&(d.onclick=R)});async function R(){const n=document.getElementById("result"),d=document.getElementById("address"),r=document.getElementById("search");if(n.innerHTML="",d.innerHTML="",r.value="",r.classList.remove("visible"),!window.ethereum){n.innerHTML="<b class='alert'>Necessites MetaMask per fer servir aquesta funci√≥.</b>";return}const{BrowserProvider:u,Contract:h}=await B(async()=>{const{BrowserProvider:o,Contract:a}=await import("./index-BIZAE8L5.js");return{BrowserProvider:o,Contract:a}},[]),e=new u(window.ethereum);await e.send("eth_requestAccounts",[]);const i=(await(await e.getSigner()).getAddress()).toLowerCase();d.innerHTML="<b>Adre√ßa connectada:</b> "+i;const s=new h(T,F,e);let t;try{t=await e.getBlockNumber()}catch{n.innerHTML="<b class='alert'>No s'ha pogut obtenir el n√∫mero de bloc. Xarxa correcta?</b>";return}try{L=(await s.queryFilter("ModelRegistered",0,t)).map(a=>({hash:a.args.hash,filename:a.args.filename,version:a.args.version,description:a.args.description,datetime:a.args.datetime,author:(a.args.author||"").toString(),blockNumber:a.blockNumber})),L.sort((a,l)=>l.blockNumber-a.blockNumber),r.classList.add("visible"),A(),r.oninput=A}catch(o){console.error(o),n.innerHTML="<b class='alert'>Error consultant els registres o massa dades a processar.<br>Revisa que est√†s a la xarxa correcta i que el contracte sigui correcte.</b>"}}function A(){const n=document.getElementById("result"),r=(document.getElementById("search").value||"").toLowerCase().trim();let u=L;if(r&&(u=u.filter(e=>e.filename&&e.filename.toLowerCase().includes(r)||e.version&&e.version.toLowerCase().includes(r)||e.description&&e.description.toLowerCase().includes(r)||e.datetime&&String(e.datetime).toLowerCase().includes(r)||e.author&&String(e.author).toLowerCase().includes(r)||e.hash&&e.hash.toLowerCase().includes(r))),u=u.slice(0,10),u.length===0){n.innerHTML="<i>No hi ha registres coincidents.</i>";return}n.innerHTML="<h3>A continuaci√≥ es mostren els 10 √∫ltims models IFC registrats a la BlockChain:</h3>",u.forEach((e,p)=>{let i=null,s=null,t=null;const o=e.description&&e.description.match(/CID:\s*([a-z0-9]+)/i);o&&(i=o[1]);const a=e.description&&e.description.match(/IMG:\s*([a-z0-9]+)/i);a&&(s=a[1]);const l=e.description&&e.description.match(/MB:\s*([\d.]+)/i);l&&(t=parseFloat(l[1]));let c="";t!==null&&!isNaN(t)&&(c=Math.ceil(t),c=Math.max(1,c),c=c*10),n.innerHTML+=`
      <div class="hash-item">
        <b>#${p+1} ‚Äî ${e.filename}</b><br>
        <span class="hash">${e.hash}</span>
        <span>Versi√≥: <b>${e.version}</b></span><br>
        <span>Descripci√≥: ${(e.description||"-").replace(/CID:\s*[a-z0-9]+/i,"").replace(/IMG:\s*[a-z0-9]+/i,"").replace(/MB:\s*[\d.]+/i,"").replace(/\n+$/,"").trim()}</span><br>
        <span style="color:#777">Data: ${S(e.datetime)}</span><br>
        <span style="color:#aaa">Author: ${e.author}</span>
        ${s?`
          <div style="display: flex; align-items: center; gap: 1.5em; margin-top: 1.2em; flex-wrap: wrap;">
            <img src="https://gateway.lighthouse.storage/ipfs/${s}" 
                 alt="Captura del model" 
                 style="max-width: 180px; border-radius: 0.6em; box-shadow: 0 2px 8px #0002; max-height: 160px;">
            <div style="display: flex; flex-direction: column; justify-content: center; align-items: flex-start; gap: 0.6em;">
              <button
              class="download-btn"
              data-cid="${i}"
              data-filename="${e.filename||"model"}.ifc"
              data-cost="${c}"
              >
              ‚¨áÔ∏è Descarregar IFC
              </button>
              ${c?`
                <span style="font-size:1.1em; color:#195186; background:#e7f6fa; border-radius:7px; padding:0.4em 0.8em; display:inline-block;">
                  üí∞ ${c} BIMCoin
                </span>
              `:""}
            </div>
          </div>
        `:""}
      </div>
    `}),document.querySelectorAll(".download-btn").forEach(e=>{e.onclick=async function(){const p=e.getAttribute("data-cid"),i=e.getAttribute("data-filename")||"model.ifc",s=Number(e.getAttribute("data-cost"))||0;window.onbeforeunload=function(t){return t.preventDefault(),t.returnValue="La desc√†rrega est√† en proc√©s. Si surts, pots perdre el fitxer pel qual ja has pagat!",t.returnValue};try{if(!s||isNaN(s)){await h(p,i,e);return}w("üí∞ Comprovant saldo de BIMCoin..."),await b(2e3);const{BrowserProvider:t,Contract:o,parseUnits:a,formatUnits:l}=await B(async()=>{const{BrowserProvider:x,Contract:$,parseUnits:k,formatUnits:N}=await import("./index-BIZAE8L5.js");return{BrowserProvider:x,Contract:$,parseUnits:k,formatUnits:N}},[]),c="0xE464B8A1FAaC982dEe365D9fB3aC1100737Ef4B5",v=["function transfer(address to, uint256 value) public returns (bool)","function decimals() public view returns (uint8)","function balanceOf(address) public view returns (uint256)"],M="0x03c89df2366f99C8e4E4C9010143d54064c0E893";w("üîå Connectant a MetaMask..."),await b(2e3);const C=new t(window.ethereum);await C.send("eth_requestAccounts",[]);const f=await C.getSigner(),y=new o(c,v,f),g=await y.decimals(),m=a(s.toString(),g),_=await f.getAddress(),D=await y.balanceOf(_);if(D<m){I(),B(()=>import("./modals-D-Pj_INv.js").then(x=>x.m),[]).then(x=>{x.showInsufficientBIMCoinModal(Number(l(D,g)),Number(l(m,g)))}),e.textContent="‚¨áÔ∏è Descarregar IFC",window.onbeforeunload=null;return}w("üí∏ Realitzant pagament amb BIMCoin..."),await b(2e3),await(await y.transfer(M,m)).wait(),E(),w("‚¨áÔ∏è Baixant fitxer IFC..."),await b(2e3),await h(p,i,e),E()}catch(t){I(),alert("‚ùå Error en el pagament o desc√†rrega: "+(t.message||t)),e.textContent="‚¨áÔ∏è Descarregar IFC"}finally{window.onbeforeunload=null,I()}}});async function h(e,p,i){try{w("‚¨áÔ∏è Iniciant desc√†rrega IFC..."),await b(2e3);const s=await fetch(`https://gateway.lighthouse.storage/ipfs/${e}`);if(!s.ok)throw new Error("No s'ha pogut descarregar el fitxer");const t=s.headers.get("Content-Length");if(!s.body)throw new Error("La resposta no t√© body stream!");const o=t?parseInt(t,10):null,a=s.body.getReader();let l=0,c=[];i.textContent="Descarregant... 0%";let v=0;for(;;){const{done:y,value:g}=await a.read();if(y)break;if(c.push(g),l+=g.length,o){const m=Math.floor(l/o*100);i.textContent=`Descarregant... ${m}%`,(m-v>=10||m===100)&&(w(`‚¨áÔ∏è Baixant fitxer... ${m}%`),await b(2e3),v=m)}else i.textContent=`Descarregant... (${(l/1024/1024).toFixed(1)} MB)`}I();const M=new Blob(c),C=window.URL.createObjectURL(M),f=document.createElement("a");f.href=C,f.download=p,document.body.appendChild(f),f.click(),setTimeout(()=>{window.URL.revokeObjectURL(C),f.remove(),i.textContent="‚¨áÔ∏è Descarregar IFC"},1e3)}catch{I(),alert("Error descarregant el fitxer IFC!"),i.textContent="‚¨áÔ∏è Descarregar IFC"}}}function S(n){if(!n)return"";const[d,r]=n.split("T"),[u,h,e]=d.split("-"),p=r?r.slice(0,5):"";return`${e}/${h}/${u}${p?" ("+p+")":""}`}function b(n){return new Promise(d=>setTimeout(d,n))}
