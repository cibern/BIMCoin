import"./modulepreload-polyfill-B5Qt9EMX.js";import"./main-h_AX3BuX.js";import{BrowserProvider as B,Contract as f,parseUnits as C}from"https://cdn.jsdelivr.net/npm/ethers@6.10.0/+esm";import"./html2canvas.esm-CBrSDip1.js";import"./modals-D-Pj_INv.js";import"./_commonjsHelpers-D6-XlEtG.js";import"./index-BIZAE8L5.js";const h="0x03c89df2366f99C8e4E4C9010143d54064c0E893",T="0xE464B8A1FAaC982dEe365D9fB3aC1100737Ef4B5",v=[{inputs:[{internalType:"string",name:"hash",type:"string"}],name:"getModelInfo",outputs:[{internalType:"string",name:"filename",type:"string"},{internalType:"string",name:"version",type:"string"},{internalType:"string",name:"description",type:"string"},{internalType:"string",name:"datetime",type:"string"},{internalType:"address",name:"author",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"string",name:"hash",type:"string"}],name:"isModelRegistered",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"}],L=["function balanceOf(address) view returns (uint256)","function decimals() view returns (uint8)","function transfer(address to, uint256 amount) returns (bool)"];function A(){return new URLSearchParams(window.location.search).get("hash")||""}document.getElementById("hash-input").value=A();document.getElementById("download-form").addEventListener("submit",async function(u){u.preventDefault();const i=document.getElementById("hash-input").value.trim().toLowerCase();if(!i){alert("Introdueix el hash del model!");return}document.getElementById("download-result").innerHTML="üîó Comprovant registre a la blockchain...";try{if(!window.ethereum)throw new Error("Necessites MetaMask instal¬∑lat.");const t=new B(window.ethereum);await t.send("eth_requestAccounts",[]);const p=await t.getSigner(),M=await p.getAddress(),g=new f(h,v,t),c=new f(T,L,p);if(!await g.isModelRegistered(i))throw new Error("Aquest hash no est√† registrat!");const e=await g.getModelInfo(i);let l=null;const d=e.description.match(/CID: ([a-zA-Z0-9]+)/i);if(d&&d[1]&&(l=d[1]),!l)throw new Error("No s'ha trobat el CID a la descripci√≥.");let r=null;const m=e.description.match(/MB: ([0-9.]+)/i);if(m&&m[1]&&(r=parseFloat(m[1])),!r)throw new Error("No s'ha trobat el pes (MB) a la descripci√≥.");let w=Math.max(10,Math.ceil(r)*10);document.getElementById("download-result").innerHTML=`
      <span style="color:#2379ca;">Pagament requerit:</span><br>
      <b>${w} BIMCoin</b> (${r.toFixed(2)} MB)<br>
      <button id="pay-bimc-btn" style="margin-top:1em;background:#2379ca;color:#fff;padding:0.6em 2.2em;border:none;border-radius:7px;cursor:pointer;font-size:1em;">Pagar amb MetaMask</button>
      <div style="margin-top:0.8em;color:#555;font-size:0.96em;">
        Un cop fet el pagament, podr√†s descarregar el model.
      </div>
    `,document.getElementById("pay-bimc-btn").onclick=async()=>{try{const o=await c.decimals(),b=C(String(w),o);if(await c.balanceOf(M)<b){alert("No tens prou BIMCoins!");return}document.getElementById("download-result").innerHTML="‚è≥ Signant transacci√≥ amb MetaMask...",await(await c.transfer(h,b)).wait();const E=`https://gateway.lighthouse.storage/ipfs/${l}`;document.getElementById("download-result").innerHTML=`
          <span style="color:green;">‚úÖ Pagament confirmat! Descarregant el teu model...</span>
          <div style="margin-top:0.8em;color:#444;">
            <b>Nom:</b> ${e.filename}<br>
            <b>Versi√≥:</b> ${e.version}<br>
            <b>Data/hora:</b> ${e.datetime}<br>
            <b>Autor:</b> ${e.author}
          </div>
        `;try{const s=await fetch(E);if(!s.ok)throw new Error("No s'ha pogut baixar l'arxiu d'IPFS.");const I=await s.blob();let n=e.filename||"model.ifc";n.toLowerCase().endsWith(".ifc")||(n=n.replace(/\.[^/.]+$/,""),n+=".ifc");const y=window.URL.createObjectURL(I),a=document.createElement("a");a.href=y,a.download=n,document.body.appendChild(a),a.click(),a.remove(),window.URL.revokeObjectURL(y),document.getElementById("download-result").innerHTML+='<br><span style="color:green;">‚úÖ Arxiu descarregat correctament!</span>'}catch(s){document.getElementById("download-result").innerHTML+=`<br><span style="color:#c00;">‚ùå Error durant la desc√†rrega: ${s.message}</span>`}}catch(o){document.getElementById("download-result").innerHTML=`<span style="color:#c00;">‚ùå Error durant el pagament: ${o.message||o}</span>`}}}catch(t){document.getElementById("download-result").innerHTML=`<span style="color:#c00;">‚ùå Error: ${t.message}</span>`}});
