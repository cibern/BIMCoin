import"./modulepreload-polyfill-B5Qt9EMX.js";import{_ as B,s as g,h as y}from"./modals-D-Pj_INv.js";import{u as L}from"./bimcoin-DS6TUAdR.js";import{C as _,a as R}from"./blockchainConfig-nCfmhYd7.js";import"https://cdn.jsdelivr.net/npm/ethers@6.10.0/+esm";let E=[];document.addEventListener("DOMContentLoaded",async()=>{L();const r=document.getElementById("contractAddr");r&&(r.textContent=_);const d=document.getElementById("connect");d&&(d.onclick=S)});async function S(){const r=document.getElementById("result"),d=document.getElementById("address"),n=document.getElementById("search");if(r.innerHTML="",d.innerHTML="",n.value="",n.classList.remove("visible"),!window.ethereum){r.innerHTML="<b class='alert'>Necessites MetaMask per fer servir aquesta funci√≥.</b>";return}const{BrowserProvider:u,Contract:m}=await B(async()=>{const{BrowserProvider:o,Contract:a}=await import("./index-BIZAE8L5.js");return{BrowserProvider:o,Contract:a}},[]),e=new u(window.ethereum);await e.send("eth_requestAccounts",[]);const i=(await(await e.getSigner()).getAddress()).toLowerCase();d.innerHTML="<b>Adre√ßa connectada:</b> "+i;const s=new m(_,R,e);let t;try{t=await e.getBlockNumber()}catch{r.innerHTML="<b class='alert'>No s'ha pogut obtenir el n√∫mero de bloc. Xarxa correcta?</b>";return}try{E=(await s.queryFilter("ModelRegistered",0,t)).map(a=>({hash:a.args.hash,filename:a.args.filename,version:a.args.version,description:a.args.description,datetime:a.args.datetime,author:(a.args.author||"").toString(),blockNumber:a.blockNumber})),E.sort((a,l)=>l.blockNumber-a.blockNumber),n.classList.add("visible"),A(),n.oninput=A}catch(o){console.error(o),r.innerHTML="<b class='alert'>Error consultant els registres o massa dades a processar.<br>Revisa que est√†s a la xarxa correcta i que el contracte sigui correcte.</b>"}}function A(){const r=document.getElementById("result"),n=(document.getElementById("search").value||"").toLowerCase().trim();let u=E;if(n&&(u=u.filter(e=>e.filename&&e.filename.toLowerCase().includes(n)||e.version&&e.version.toLowerCase().includes(n)||e.description&&e.description.toLowerCase().includes(n)||e.datetime&&String(e.datetime).toLowerCase().includes(n)||e.author&&String(e.author).toLowerCase().includes(n)||e.hash&&e.hash.toLowerCase().includes(n))),u=u.slice(0,10),u.length===0){r.innerHTML="<i>No hi ha registres coincidents.</i>";return}r.innerHTML="<h3>A continuaci√≥ es mostren els 10 √∫ltims models IFC registrats a la BlockChain:</h3>",u.forEach((e,p)=>{let i=null,s=null,t=null;const o=e.description&&e.description.match(/CID:\s*([a-z0-9]+)/i);o&&(i=o[1]);const a=e.description&&e.description.match(/IMG:\s*([a-z0-9]+)/i);a&&(s=a[1]);const l=e.description&&e.description.match(/MB:\s*([\d.]+)/i);l&&(t=parseFloat(l[1]));let c="";t!==null&&!isNaN(t)&&(c=Math.ceil(t),c=Math.max(1,c),c=c*10),r.innerHTML+=`
      <div class="hash-item">
        <b>#${p+1} ‚Äî ${e.filename}</b><br>
        <span class="hash">${e.hash}</span>
        <span>Versi√≥: <b>${e.version}</b></span><br>
        <span>Descripci√≥: ${(e.description||"-").replace(/CID:\s*[a-z0-9]+/i,"").replace(/IMG:\s*[a-z0-9]+/i,"").replace(/MB:\s*[\d.]+/i,"").replace(/\n+$/,"").trim()}</span><br>
        <span style="color:#777">Data: ${F(e.datetime)}</span><br>
        <span style="color:#aaa">Author: ${e.author}</span>
        ${s?`
          <div style="display: flex; align-items: center; gap: 1.5em; margin-top: 1.2em; flex-wrap: wrap;">
            <img src="https://gateway.lighthouse.storage/ipfs/${s}" 
                 alt="Captura del model" 
                 style="max-width: 180px; border-radius: 0.6em; box-shadow: 0 2px 8px #0002; max-height: 160px;">
            <div style="display: flex; flex-direction: column; justify-content: center; align-items: flex-start; gap: 0.6em;">
              <button
              class="download-btn"
              data-cid="${i}"
              data-filename="${e.filename||"model"}.ifc"
              data-cost="${c}"
              >
              ‚¨áÔ∏è Descarregar IFC
              </button>
              ${c?`
                <span style="font-size:1.1em; color:#195186; background:#e7f6fa; border-radius:7px; padding:0.4em 0.8em; display:inline-block;">
                  üí∞ ${c} BIMCoin
                </span>
              `:""}
            </div>
          </div>
        `:""}
      </div>
    `}),document.querySelectorAll(".download-btn").forEach(e=>{e.onclick=async function(){const p=e.getAttribute("data-cid"),i=e.getAttribute("data-filename")||"model.ifc",s=Number(e.getAttribute("data-cost"))||0;window.onbeforeunload=function(t){return t.preventDefault(),t.returnValue="La desc√†rrega est√† en proc√©s. Si surts, pots perdre el fitxer pel qual ja has pagat!",t.returnValue};try{if(!s||isNaN(s)){await m(p,i,e);return}g("üí∞ Comprovant saldo de BIMCoin..."),await b(2e3);const{BrowserProvider:t,Contract:o,parseUnits:a,formatUnits:l}=await B(async()=>{const{BrowserProvider:v,Contract:N,parseUnits:T,formatUnits:k}=await import("./index-BIZAE8L5.js");return{BrowserProvider:v,Contract:N,parseUnits:T,formatUnits:k}},[]),c="0xE464B8A1FAaC982dEe365D9fB3aC1100737Ef4B5",x=["function transfer(address to, uint256 value) public returns (bool)","function decimals() public view returns (uint8)","function balanceOf(address) public view returns (uint256)"],M="0x03c89df2366f99C8e4E4C9010143d54064c0E893";g("üîå Connectant a MetaMask..."),await b(2e3);const C=new t(window.ethereum);await C.send("eth_requestAccounts",[]);const h=await C.getSigner(),I=new o(c,x,h),w=await I.decimals(),f=a(s.toString(),w),$=await h.getAddress(),D=await I.balanceOf($);if(D<f){y(),B(()=>import("./modals-D-Pj_INv.js").then(v=>v.m),[]).then(v=>{v.showInsufficientBIMCoinModal(Number(l(D,w)),Number(l(f,w)))}),e.textContent="‚¨áÔ∏è Descarregar IFC",window.onbeforeunload=null;return}g("üí∏ Realitzant pagament amb BIMCoin..."),await b(2e3),await(await I.transfer(M,f)).wait(),L(),g("‚¨áÔ∏è Baixant fitxer IFC..."),await b(2e3),await m(p,i,e),L()}catch(t){y(),alert("‚ùå Error en el pagament o desc√†rrega: "+(t.message||t)),e.textContent="‚¨áÔ∏è Descarregar IFC"}finally{window.onbeforeunload=null,y()}}});async function m(e,p,i){try{g("‚¨áÔ∏è Iniciant desc√†rrega IFC..."),await b(2e3);const s=await fetch(`https://gateway.lighthouse.storage/ipfs/${e}`);if(!s.ok)throw new Error("No s'ha pogut descarregar el fitxer");const t=s.headers.get("Content-Length");if(!s.body)throw new Error("La resposta no t√© body stream!");const o=t?parseInt(t,10):null,a=s.body.getReader();let l=0,c=[];i.textContent="Descarregant... 0%";let x=0;for(;;){const{done:I,value:w}=await a.read();if(I)break;if(c.push(w),l+=w.length,o){const f=Math.floor(l/o*100);i.textContent=`Descarregant... ${f}%`,(f-x>=10||f===100)&&(g(`‚¨áÔ∏è Baixant fitxer... ${f}%`),await b(2e3),x=f)}else i.textContent=`Descarregant... (${(l/1024/1024).toFixed(1)} MB)`}y();const M=new Blob(c),C=window.URL.createObjectURL(M),h=document.createElement("a");h.href=C,h.download=p,document.body.appendChild(h),h.click(),setTimeout(()=>{window.URL.revokeObjectURL(C),h.remove(),i.textContent="‚¨áÔ∏è Descarregar IFC"},1e3)}catch{y(),alert("Error descarregant el fitxer IFC!"),i.textContent="‚¨áÔ∏è Descarregar IFC"}}}function F(r){if(!r)return"";const[d,n]=r.split("T"),[u,m,e]=d.split("-"),p=n?n.slice(0,5):"";return`${e}/${m}/${u}${p?" ("+p+")":""}`}function b(r){return new Promise(d=>setTimeout(d,r))}
