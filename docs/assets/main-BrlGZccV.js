import"./modulepreload-polyfill-B5Qt9EMX.js";import{BrowserProvider as T,Contract as y,parseUnits as L,JsonRpcProvider as R,Wallet as $,formatUnits as B}from"https://cdn.jsdelivr.net/npm/ethers@6.10.0/+esm";const I="0x03c89df2366f99C8e4E4C9010143d54064c0E893",N="0xE464B8A1FAaC982dEe365D9fB3aC1100737Ef4B5",k=[{inputs:[{internalType:"string",name:"hash",type:"string"}],name:"getModelInfo",outputs:[{internalType:"string",name:"filename",type:"string"},{internalType:"string",name:"version",type:"string"},{internalType:"string",name:"description",type:"string"},{internalType:"string",name:"datetime",type:"string"},{internalType:"address",name:"author",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"string",name:"hash",type:"string"}],name:"isModelRegistered",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"}],D=["function balanceOf(address) view returns (uint256)","function decimals() view returns (uint8)","function transfer(address to, uint256 amount) returns (bool)"];function O(){return new URLSearchParams(window.location.search).get("hash")||""}document.getElementById("hash-input").value=O();document.getElementById("download-form").addEventListener("submit",async function(e){e.preventDefault();const r=document.getElementById("hash-input").value.trim().toLowerCase();if(!r){alert("Introdueix el hash del model!");return}document.getElementById("download-result").innerHTML="üîó Comprovant registre a la blockchain...";try{if(!window.ethereum)throw new Error("Necessites MetaMask instal¬∑lat.");const t=new T(window.ethereum);await t.send("eth_requestAccounts",[]);const a=await t.getSigner(),w=await a.getAddress(),c=new y(I,k,t),s=new y(N,D,a);if(!await c.isModelRegistered(r))throw new Error("Aquest hash no est√† registrat!");const n=await c.getModelInfo(r);let o=null;const i=n.description.match(/CID: ([a-zA-Z0-9]+)/i);if(i&&i[1]&&(o=i[1]),!o)throw new Error("No s'ha trobat el CID a la descripci√≥.");let u=null;const f=n.description.match(/MB: ([0-9.]+)/i);if(f&&f[1]&&(u=parseFloat(f[1])),!u)throw new Error("No s'ha trobat el pes (MB) a la descripci√≥.");let g=Math.max(10,Math.ceil(u)*10);document.getElementById("download-result").innerHTML=`
      <span style="color:#2379ca;">Pagament requerit:</span><br>
      <b>${g} BIMCoin</b> (${u.toFixed(2)} MB)<br>
      <button id="pay-bimc-btn" style="margin-top:1em;background:#2379ca;color:#fff;padding:0.6em 2.2em;border:none;border-radius:7px;cursor:pointer;font-size:1em;">Pagar amb MetaMask</button>
      <div style="margin-top:0.8em;color:#555;font-size:0.96em;">
        Un cop fet el pagament, podr√†s descarregar el model.
      </div>
    `,document.getElementById("pay-bimc-btn").onclick=async()=>{try{const p=await s.decimals(),h=L(String(g),p);if(await s.balanceOf(w)<h){alert("No tens prou BIMCoins!");return}document.getElementById("download-result").innerHTML="‚è≥ Signant transacci√≥ amb MetaMask...",await(await s.transfer(I,h)).wait();const A=`https://gateway.lighthouse.storage/ipfs/${o}`;document.getElementById("download-result").innerHTML=`
          <span style="color:green;">‚úÖ Pagament confirmat! Descarregant el teu model...</span>
          <div style="margin-top:0.8em;color:#444;">
            <b>Nom:</b> ${n.filename}<br>
            <b>Versi√≥:</b> ${n.version}<br>
            <b>Data/hora:</b> ${n.datetime}<br>
            <b>Autor:</b> ${n.author}
          </div>
        `;try{const m=await fetch(A);if(!m.ok)throw new Error("No s'ha pogut baixar l'arxiu d'IPFS.");const S=await m.blob();let l=n.filename||"model.ifc";l.toLowerCase().endsWith(".ifc")||(l=l.replace(/\.[^/.]+$/,""),l+=".ifc");const M=window.URL.createObjectURL(S),d=document.createElement("a");d.href=M,d.download=l,document.body.appendChild(d),d.click(),d.remove(),window.URL.revokeObjectURL(M),document.getElementById("download-result").innerHTML+='<br><span style="color:green;">‚úÖ Arxiu descarregat correctament!</span>'}catch(m){document.getElementById("download-result").innerHTML+=`<br><span style="color:#c00;">‚ùå Error durant la desc√†rrega: ${m.message}</span>`}}catch(p){document.getElementById("download-result").innerHTML=`<span style="color:#c00;">‚ùå Error durant el pagament: ${p.message||p}</span>`}}}catch(t){document.getElementById("download-result").innerHTML=`<span style="color:#c00;">‚ùå Error: ${t.message}</span>`}});const v="0xE464B8A1FAaC982dEe365D9fB3aC1100737Ef4B5",U="a99015595fa8a05de52abbfe36c84a1506d3256f8bfc1965564184e8845cffb5",F="https://sepolia.infura.io/v3/c7c69abed6d74690ad916ccfca06953a",C=[{inputs:[{internalType:"address",name:"spender",type:"address"},{internalType:"uint256",name:"value",type:"uint256"}],name:"approve",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"nonpayable",type:"function"},{inputs:[],stateMutability:"nonpayable",type:"constructor"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"owner",type:"address"},{indexed:!0,internalType:"address",name:"spender",type:"address"},{indexed:!1,internalType:"uint256",name:"value",type:"uint256"}],name:"Approval",type:"event"},{inputs:[{internalType:"address",name:"to",type:"address"},{internalType:"uint256",name:"value",type:"uint256"}],name:"transfer",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"nonpayable",type:"function"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"from",type:"address"},{indexed:!0,internalType:"address",name:"to",type:"address"},{indexed:!1,internalType:"uint256",name:"value",type:"uint256"}],name:"Transfer",type:"event"},{inputs:[{internalType:"address",name:"owner",type:"address"},{internalType:"address",name:"spender",type:"address"}],name:"allowance",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"account",type:"address"}],name:"balanceOf",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[],name:"decimals",outputs:[{internalType:"uint8",name:"",type:"uint8"}],stateMutability:"view",type:"function"},{inputs:[],name:"name",outputs:[{internalType:"string",name:"",type:"string"}],stateMutability:"view",type:"function"},{inputs:[],name:"symbol",outputs:[{internalType:"string",name:"",type:"string"}],stateMutability:"view",type:"function"},{inputs:[],name:"totalSupply",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"}],P=new R(F),_=new $(U,P),E=new y(v,C,_);async function H(){if(!window.ethereum){alert("‚ùå Necessites MetaMask instal¬∑lat.");return}try{const[e]=await window.ethereum.request({method:"eth_requestAccounts"}),r=await E.decimals(),t=100n*10n**BigInt(r);await(await E.transfer(e,t)).wait(),alert(`‚úÖ S'han enviat 100 BIMCoins a ${e}`),x()}catch(e){console.error("‚ùå Error enviant BIMCoins:",e),alert("‚ùå Error: "+(e.message||e))}}document.getElementById("buy-button").addEventListener("click",H);async function x(){if(!window.ethereum){console.warn("‚ùóÔ∏è No hi ha MetaMask o provider disponible.");return}try{const e=new T(window.ethereum),t=await(await e.getSigner()).getAddress(),a=new y(v,C,e),[w,c,s]=await Promise.all([a.balanceOf(t),a.totalSupply(),a.decimals()]),b=B(w.toString(),s),n=B(c.toString(),s),o=document.getElementById("walletBalance"),i=document.getElementById("totalSupply");o&&(o.textContent=`${parseFloat(b).toFixed(0)} BIMC`),i&&(i.textContent=`${parseFloat(n).toFixed(0)} BIMC`)}catch(e){console.error("‚ùå Error carregant info BIMCoin:",e)}}x();
